<!doctype html>

<html>
  <head>
    <meta charset="utf-8">
    <title>Hello World</title>
    <style>* {padding: 0; margin: 0}</style>
  </head>

    <script src="{{url_for('static', filename='pixi.min.js')}}"></script>
    <script src="{{url_for('static', filename='GameLoop.js')}}"></script>
    <script src="{{url_for('static', filename='playerGrid.js')}}"></script>
    <script src="{{url_for('static', filename='makemap.js')}}"> </script>
    <script src ="{{url_for('static', filename='spawnNote.js')}}"></script>
    <script src ="{{url_for('static', filename='rhythmLogic.js')}}"></script>

    <body>
      <script type="text/javascript">

      //Aliases
  const Application = PIXI.Application,
      loader = PIXI.loader,
      resources = PIXI.loader.resources,
      Sprite = PIXI.Sprite;

  //Create a Pixi Application
  const app = new Application({
      width: 900,
      height: 700,
      antialias: true,
      transparent: false,
      resolution: 1
    }
  );

const playerLoc = {}
var ready = false;
var life = 3;
var crashCheck = false;

  //Add the canvas that Pixi automatically created for you to the HTML document
  document.body.appendChild(app.view);

  //load an image and run the `setup` function when it's done
  loader
    .add("{{url_for('static', filename='images/test1.png')}}")
    .add('keyCaps',"{{url_for('static', filename='images/KeyCaps.png')}}")
    .add("{{url_for('static', filename='images/Hendrix.png')}}")
    .load(gridSetup);



    //Set the game state
    state = play;
    //Start the game loop
   app.ticker.add(delta => gameLoop(delta));


    function gameLoop(delta){

      //Update the current game state:
      state(delta);
    }

    function play(delta) {

      loader.onComplete.add(() => ready = true);
      if (ready){

        //play the rhythm componenet
        playRhythm();

        //play dodge component
        dodgeNotes();

      }
    }
        var mapTextures = setupMap();
        // buildMap(mapTextures);

        var MM = new musicManager();
        app.ticker.add((delta) => MM.update(delta));
        MM.startTrack(144, ['0000001100000011',
          '0000110000001100',
          '0011000000110000',
          '1100000011000000']);
        // MM.pushNoteLane('Q', 3.0);
        // MM.pushNoteLane('W', 3.0);
        // MM.pushNoteLane('E', 3.0);
        // MM.pushNoteLane('R', 3.0);

        function playRhythm(){
          //Q hit logic
          if(sprites.keyQ.click){
            console.log("Q bang");
            if(MM.handleCollision('Q')){
              console.log("hit");
            }
            else {
              console.log("miss");
              lifeHit();
            }
            sprites.keyQ.click = false;
          }

          //W hit logic
          if(sprites.keyW.click){
            console.log("W bang");
            if(MM.handleCollision('W')){
              console.log("hit");
            }
            else {
              console.log("miss");
              lifeHit();
            }
            sprites.keyW.click = false;
          }

          //E hit logic
          if(sprites.keyE.click){
            console.log("E bang");
            if(MM.handleCollision('E')){
              console.log("hit");
            }
            else {
              console.log("miss");
              lifeHit();
            }
            sprites.keyE.click = false;
          }

          //R hit logic
          if(sprites.keyR.click){
            console.log("R bang");
            if(MM.handleCollision('R')){
              console.log("hit");
            }
            else {
              console.log("miss");
              lifeHit();
            }
            sprites.keyR.click = false;
          }

          numberEscapedBoundary = MM.handleBoundary(sprites.keyQ.y+50)
          for (let index = 0; index < numberEscapedBoundary; index++){
            lifeHit();
          }

        }

        function dodgeNotes(){
          if (MM.handleCrash(sprites.player.x, sprites.player.y)){
            lifeHit();
            console.log("crash");
          }
        }

        function lifeHit(){
          life--;
          console.log(life);
        }


      </script>
    </body>
</html>
